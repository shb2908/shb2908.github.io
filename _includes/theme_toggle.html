<!-- Theme Toggle Button -->
<div class="theme-toggle" id="themeToggle">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24">
      <path id="themeIcon" d="M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4s1.8,4,4,4s4-1.8,4-4S14.2,8,12,8z M12,2 c-5.5,0-10,4.5-10,10s4.5,10,10,10s10-4.5,10-10S17.5,2,12,2z"/>
    </svg>
  </div>
  
  <!-- Theme Selection Menu -->
  <div class="theme-menu" id="themeMenu">
    <div class="theme-option" data-theme="system">Follow System</div>
    <div class="theme-option" data-theme="light">Light Mode</div>
    <div class="theme-option" data-theme="dark">Dark Mode</div>
  </div>
  
  <script>
  (function() {
    const ThemeManager = {
      init() {
        this.themeToggle = document.getElementById('themeToggle');
        this.themeIcon = document.getElementById('themeIcon');
        this.themeMenu = document.getElementById('themeMenu');
        this.themeOptions = document.querySelectorAll('.theme-option');
        this.body = document.body;
  
        // Hide menu initially
        this.themeMenu.style.display = 'none';
  
        this.bindEvents();
        this.initTheme();
      },
  
      bindEvents() {
        // Toggle menu on button click
        this.themeToggle.addEventListener('click', (e) => {
          e.stopPropagation();
          const currentDisplay = this.themeMenu.style.display;
          this.themeMenu.style.display = currentDisplay === 'block' ? 'none' : 'block';
          this.highlightActiveOption();
        }, { once: false });
  
        // Switch theme on option click
        this.themeOptions.forEach(option => {
          option.addEventListener('click', (e) => {
            e.stopPropagation();
            const theme = option.getAttribute('data-theme');
            this.setTheme(theme);
            this.themeMenu.style.display = 'none';
          });
        });
  
        // Hide menu when clicking outside
        document.addEventListener('click', (e) => {
          if (!this.themeMenu.contains(e.target) && e.target !== this.themeToggle) {
            this.themeMenu.style.display = 'none';
          }
        });
  
        // Listen for system theme changes (only in system mode)
        this.systemThemeQuery = window.matchMedia('(prefers-color-scheme: dark)');
        this.systemThemeQuery.addEventListener('change', () => {
          const currentTheme = localStorage.getItem('theme') || 'system';
          if (currentTheme === 'system') {
            this.initTheme();
          }
        });
      },
  
      // Initialize theme
      initTheme() {
        try {
          const savedTheme = localStorage.getItem('theme') || 'system';
          const prefersDark = this.systemThemeQuery.matches;
          
          // Set page theme based on saved preference
          if (savedTheme === 'system') {
            // Follow system
            this.body.classList.toggle('dark-mode', prefersDark);
            this.updateIcon(prefersDark);
          } else if (savedTheme === 'dark') {
            // Dark theme
            this.body.classList.add('dark-mode');
            this.updateIcon(true);
          } else {
            // Light theme
            this.body.classList.remove('dark-mode');
            this.updateIcon(false);
          }
  
          this.highlightActiveOption();
        } catch (e) {
          console.error('Theme initialization failed:', e);
        }
      },
  
      // Set theme
      setTheme(theme) {
        localStorage.setItem('theme', theme);
        
        if (theme === 'system') {
          // Follow system
          const prefersDark = this.systemThemeQuery.matches;
          this.body.classList.toggle('dark-mode', prefersDark);
          this.updateIcon(prefersDark);
        } else if (theme === 'dark') {
          // Dark theme
          this.body.classList.add('dark-mode');
          this.updateIcon(true);
        } else {
          // Light theme
          this.body.classList.remove('dark-mode');
          this.updateIcon(false);
        }
  
        this.highlightActiveOption();
      },
  
      // Update icon
      updateIcon(isDark) {
        try {
          const darkPath = "M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M12,3A9,9 0 0,0 3,12A9,9 0 0,0 12,21A9,9 0 0,0 21,12A9,9 0 0,0 12,3M12,19A7,7 0 0,1 5,12A7,7 0 0,1 12,5A7,7 0 0,1 19,12A7,7 0 0,1 12,19Z";
          const lightPath = "M12,18c-3.3,0-6-2.7-6-6s2.7-6,6-6s6,2.7,6,6S15.3,18,12,18zM12,8c-2.2,0-4,1.8-4,4s1.8,4,4,4s4-1.8,4-4S14.2,8,12,8z M12,2 c-5.5,0-10,4.5-10,10s4.5,10,10,10s10-4.5,10-10S17.5,2,12,2z";
          
          this.themeIcon.setAttribute('d', isDark ? darkPath : lightPath);
        } catch (e) {
          console.error('Icon update failed:', e);
        }
      },
  
      // Highlight active option
      highlightActiveOption() {
        const currentTheme = localStorage.getItem('theme') || 'system';
        this.themeOptions.forEach(option => {
          if (option.getAttribute('data-theme') === currentTheme) {
            option.classList.add('active');
          } else {
            option.classList.remove('active');
          }
        });
      }
    };
  
    // Initialize
    ThemeManager.init();
  })();
  </script>